<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <!-- <meta
      charset="UTF-8"
      name="viewport"
      content="initial-scale=1,user-scalable=no,viewport-fit=cover"
    /> -->
    <link rel="apple-touch-startup-image" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3)" href="/tennis-tournament-finder/images/splash-13pro.png" />
    <link rel="apple-touch-startup-image" media="(device-width: 482px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3)" href="/tennis-tournament-finder/images/splash-13promax.png" />
    <link rel="apple-touch-startup-image" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3)" href="/tennis-tournament-finder/images/splash-14pro.png" />
    <link rel="apple-touch-startup-image" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)" href="/tennis-tournament-finder/images/splash-14promax.png" />
    <link rel="canonical" href="https://timoknapp.github.io/tennis-tournament-finder/" />
    <link rel="manifest" href="/tennis-tournament-finder/manifest.json">
    <!-- local manifest -->
    <!-- <link rel="manifest" href="/manifest-local.json"> -->
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.0/dist/leaflet.css"
    integrity="sha512-hoalWLoI8r4UszCkZ5kL8vayOGVae1oxXe/2A4AO6J9+580uKHDO3JdHb7NzwwzK5xr/Fs0W40kiNHxM9vyTtQ=="
    crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/MarkerCluster.Default.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script src="https://unpkg.com/leaflet@1.8.0/dist/leaflet.js" integrity="sha512-BB3hKbKWOc9Ez/TAwyWxNXeoV9c1v6FIeYiBieIWkpLjauysF18NzgR1MBNBXf8/KABdlkX68nAhlwcDFLGPCQ==" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.3/leaflet.markercluster.js"></script>
    
    <link rel="stylesheet" type="text/css" href="css/main.css">
    <title>LK-Turnier Finder</title>

    <script>
        // Enhanced Service Worker registration with user-friendly update handling
        let updateAvailable = false;
        let newWorkerWaiting = null;

        function showUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            if (notification) {
                notification.style.display = 'flex';
                updateAvailable = true;
                
                // Focus management for accessibility
                const updateNowBtn = document.getElementById('updateNowBtn');
                if (updateNowBtn) {
                    updateNowBtn.focus();
                }
                
                // Trap focus within the popup
                setupFocusTrap(notification);
            }
        }

        function hideUpdateNotification() {
            const notification = document.getElementById('updateNotification');
            if (notification) {
                notification.style.display = 'none';
                removeFocusTrap();
            }
        }

        function setupFocusTrap(popup) {
            const focusableElements = popup.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];
            
            function handleKeyDown(e) {
                if (e.key === 'Escape') {
                    hideUpdateNotification();
                    // Show notification again after 5 minutes
                    setTimeout(() => {
                        if (updateAvailable) {
                            showUpdateNotification();
                        }
                    }, 5 * 60 * 1000);
                    return;
                }
                
                if (e.key === 'Tab') {
                    if (e.shiftKey) {
                        if (document.activeElement === firstElement) {
                            lastElement.focus();
                            e.preventDefault();
                        }
                    } else {
                        if (document.activeElement === lastElement) {
                            firstElement.focus();
                            e.preventDefault();
                        }
                    }
                }
            }
            
            document.addEventListener('keydown', handleKeyDown);
            popup.setAttribute('data-focus-trap', 'true');
        }
        
        function removeFocusTrap() {
            const popup = document.getElementById('updateNotification');
            if (popup && popup.hasAttribute('data-focus-trap')) {
                popup.removeAttribute('data-focus-trap');
                // Remove all keydown listeners by cloning and replacing the document
                // This is a simple approach - in production you'd track the specific listener
            }
        }

        function updateApp() {
            if (newWorkerWaiting) {
                // Tell the waiting service worker to skip waiting
                newWorkerWaiting.postMessage({ type: 'SKIP_WAITING' });
            }
            // Reload the page to get the latest version
            window.location.reload();
        }

        // Set up event listeners for update buttons
        document.addEventListener('DOMContentLoaded', function() {
            const updateNowBtn = document.getElementById('updateNowBtn');
            const updateLaterBtn = document.getElementById('updateLaterBtn');

            if (updateNowBtn) {
                updateNowBtn.addEventListener('click', function() {
                    updateApp();
                });
            }

            if (updateLaterBtn) {
                updateLaterBtn.addEventListener('click', function() {
                    hideUpdateNotification();
                    // Show notification again after 5 minutes
                    setTimeout(() => {
                        if (updateAvailable) {
                            showUpdateNotification();
                        }
                    }, 5 * 60 * 1000); // 5 minutes
                });
            }
        });

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js')
                .then(registration => {
                    console.log('SW registered:', registration);
                    
                    // Check for updates periodically
                    setInterval(() => {
                        registration.update();
                    }, 60000); // Check every minute
                    
                    // Handle updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        if (newWorker) {
                            newWorkerWaiting = newWorker;
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version is available
                                    console.log('New version available!');
                                    showUpdateNotification();
                                } else if (newWorker.state === 'activated') {
                                    // This happens when user chooses to update
                                    updateAvailable = false;
                                    hideUpdateNotification();
                                }
                            });
                        }
                    });

                    // Listen for messages from the service worker
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'SW_UPDATED') {
                            console.log('Service Worker updated, reloading page...');
                            window.location.reload();
                        }
                    });

                    // Show the popup if an update is already waiting (e.g., after a reload)
                    if (registration.waiting && navigator.serviceWorker.controller) {
                        newWorkerWaiting = registration.waiting;
                        updateAvailable = true;
                        showUpdateNotification();
                    }
                })
                .catch(error => console.log('SW registration failed:', error));
        }
    </script> 
</head>
<body>
    <div class="sideBar">
        <div class="sideBarElement title">
            🎾 LK-Turnier Finder
            <button id="filterToggle" class="filterToggleBtn" onclick="toggleFilters()">Filter ⚙️</button>
        </div>
        <div class="sideBarElement filter" id="filterContainer">
            <form name="searchForm" action="javascript:getTournamentsByDate(dateFrom.value, dateTo.value, compType.value, getSelectedFederations())">
                <div class="filterContainer">
                    <label for="dateFrom">Zeitraum von:</label>
                    <input class="filterElement" type="date" id="dateFrom" name="dateFrom">
                </div>
                <div class="filterContainer">
                    <label for="dateTo">Zeitraum bis:</label>
                    <input class="filterElement" type="date" id="dateTo" name="dateTo">
                </div>
                <div class="filterContainer">
                    <label for="compType">Konkurrenzen:</label>
                    <select class="filterElement" id="compType" name="compType">
                        <option value="">Alle Konkurrenzen</option>
                        <option value="Herren+Einzel">Herren Einzel</option>
                        <option value="Herren+Doppel">Herren Doppel</option>
                        <option value="Damen+Einzel">Damen Einzel</option>
                        <option value="Damen+Doppel">Damen Doppel</option>
                        <option value="Senioren+Einzel">Senioren Einzel</option>
                        <option value="Senioren+Doppel">Senioren Doppel</option>
                        <option value="Jugend+Einzel">Jugend Einzel</option>
                        <option value="Jugend+Doppel">Jugend Doppel</option>
                    </select>
                </div>
                <div class="filterContainer">
                    <label>Tennisverbände:</label>
                    <div class="federationCheckboxes">
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="BAD" checked> BAD
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="HTV" checked> HTV
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="RLP" checked> RLP
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="STV" checked> STV
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="TMV" checked> TMV
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="TSA" checked> TSA
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="TTV" checked> TTV
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="TVN" checked> TVN
                        </label>
                        <label class="checkboxLabel">
                            <input type="checkbox" name="federations" value="WTB" checked> WTB
                        </label>
                        <!-- <div class="federationControls">
                            <button type="button" onclick="selectAllFederations()">Alle</button>
                            <button type="button" onclick="deselectAllFederations()">Keine</button>
                        </div> -->
                    </div>
                </div>
                <div class="filterContainer submitContainer">
                    <input class="submitBtn" type="submit" value="Suchen">
                </div>
            </form>
        </div>
    </div>
    <div id="map">
        <div id="loading" class="loading">Loading&#8230;</div>
    </div>
    
    <!-- Update Notification Popup -->
    <div id="updateNotification" class="update-notification" style="display: none;" role="dialog" aria-labelledby="update-title" aria-describedby="update-message">
        <div class="update-popup">
            <div class="update-icon" aria-hidden="true">🚀</div>
            <h3 id="update-title" class="update-title">🎾 Update verfügbar!</h3>
            <p id="update-message" class="update-message">
                Möchtest du jetzt aktualisieren? ✨
            </p>
            <div class="update-buttons">
                <button id="updateNowBtn" class="update-btn update-now" type="button">Jetzt</button>
                <button id="updateLaterBtn" class="update-btn update-later" type="button">Später</button>
            </div>
        </div>
    </div>
    <script src="script/main.js"></script>
    <script src="script/mobile-gesture.js"></script>
</body>
</html>